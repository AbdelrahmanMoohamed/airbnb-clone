<div class="broker-detail-container">

  <!-- Loading State -->
  <div *ngIf="loading" class="broker-loading-section">
    <div class="broker-character-container">
      <img src="/3.png" alt="The Broker Character" class="loading-character" />
      <div class="loading-accent-circle"></div>
    </div>
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <h3>{{ 'listings.loadingProperty' | translate }}</h3>
      <p>{{ 'listings.preparingDetails' | translate }}</p>
    </div>
  </div>

  <!-- Error State -->
  <div *ngIf="error && !loading" class="broker-error-section">
    <div class="broker-character-container">
      <img src="/3.png" alt="The Broker Character" class="error-character" />
      <div class="error-accent-circle"></div>
    </div>
    <div class="error-content">
      <i class="bi bi-exclamation-triangle"></i>
      <h3>{{ 'listings.errorOccurred' | translate }}</h3>
      <p>{{ error }}</p>
      <button class="btn-broker" (click)="goBack()">
        <i class="bi bi-arrow-left"></i>
        {{ 'listings.backToListings' | translate }}
      </button>
    </div>
  </div>

  <!-- Main Content -->
  <div *ngIf="listing && !loading && !error" class="broker-detail-content">

    <!-- Hero Section with Character -->
    <div class="broker-detail-hero">
      <div class="container-fluid">
        <div class="row align-items-center">
          <!-- Character Section -->
          <div class="col-md-3 d-flex justify-content-center">
            <div class="broker-character-container">
              <img src="/3.png" alt="The Broker Character" class="detail-character" />
              <div class="detail-accent-circle"></div>
            </div>
          </div>

          <!-- Property Header Section -->
          <div class="col-md-9">
            <div class="broker-property-header">
              <!-- Navigation -->
              <nav class="property-breadcrumb">
                <a [routerLink]="['/listings']" class="breadcrumb-link">
                  <i class="bi bi-house-door"></i>
                  {{ 'listings.allProperties' | translate }}
                </a>
                <i class="bi bi-chevron-right"></i>
                <span class="current-page">{{ listing.title }}</span>
              </nav>

              <!-- Property Title & Status -->
              <div class="property-title-section">
                <h1 class="property-title">{{ listing.title }}</h1>
                <!-- Favorite Button Integration -->
                <app-favorite-button [listingId]="listing.id" [isFavorited]="isFavorited"
                  (favoriteChanged)="onFavoriteChanged($event)">
                </app-favorite-button>

                <div class="property-status" [class.approved]="listing.isApproved"
                  [class.pending]="!listing.isApproved">
                  <i class="bi" [class.bi-check-circle-fill]="listing.isApproved"
                    [class.bi-clock-fill]="!listing.isApproved"></i>
                  {{ listing.isApproved ? ('listings.approved' | translate) : ('listings.pending' | translate) }}
                </div>
              </div>

              <!-- Property Meta Info -->
              <div class="property-meta">
                <div class="meta-item location">
                  <i class="bi bi-geo-alt-fill"></i>
                  <span>{{ listing.location }}</span>
                </div>
                <div class="meta-item rating" *ngIf="listing.averageRating">
                  <i class="bi bi-star-fill"></i>
                  <span>{{ listing.averageRating.toFixed(1) }} ({{ listing.reviewCount }} {{ 'listings.reviews' |
                    translate }})</span>
                </div>
                <div class="meta-item rating" *ngIf="!listing.averageRating">
                  <i class="bi bi-star"></i>
                  <span>{{ 'listings.noReviewsYet' | translate }}</span>
                </div>
              </div>

              <!-- Quick Actions -->
              <div class="quick-actions">
                <button class="btn-broker-primary" [routerLink]="['/booking/create', listing.id]">
                  <i class="bi bi-calendar-check"></i>
                  {{ 'listings.bookNow' | translate }}
                </button>
                <button class="btn-broker-outline" (click)="editListing()" *ngIf="canEdit">
                  <i class="bi bi-pencil"></i>
                  {{ 'listings.edit' | translate }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Property Showcase Section -->
    <div class="broker-showcase-section">
      <div class="container-fluid">
        <div class="row">

          <!-- Image Gallery -->
          <div class="col-lg-8">
            <div class="broker-image-gallery">

              <!-- Main Image Display -->
              <div class="main-image-container">
                <img [src]="listing.images && listing.images.length > 0
                    ? listing.images[currentImageIndex].imageUrl
                    : '/assets/images/placeholder-listing.jpg'" [alt]="listing.title" class="main-property-image" />

                <!-- Image Navigation -->
                <button *ngIf="listing.images && listing.images.length > 1" class="image-nav-btn prev"
                  (click)="prevImage()">
                  <i class="bi bi-chevron-left"></i>
                </button>
                <button *ngIf="listing.images && listing.images.length > 1" class="image-nav-btn next"
                  (click)="nextImage()">
                  <i class="bi bi-chevron-right"></i>
                </button>

                <!-- Image Counter -->
                <div class="image-counter" *ngIf="listing.images && listing.images.length > 1">
                  {{ currentImageIndex + 1 }} / {{ listing.images.length }}
                </div>
              </div>

              <!-- Thumbnails -->
              <div class="image-thumbnails" *ngIf="listing.images && listing.images.length > 1">
                <button *ngFor="let img of listing.images; let i = index" class="thumbnail-btn"
                  [class.active]="i === currentImageIndex" (click)="selectImage(i)">
                  <img [src]="img.imageUrl" [alt]="'Image ' + (i + 1)" class="thumbnail-image" />
                </button>
              </div>
            </div>
          </div>

          <!-- Property Details -->
          <div class="col-lg-4">
            <div class="broker-property-details">

              <!-- Price Section -->
              <div class="price-section">
                <div class="price-main">
                  <span class="price-amount">{{ listing.pricePerNight }}</span>
                  <span class="price-currency">{{ 'listings.egp' | translate }}</span>
                </div>
                <div class="price-period">{{ 'listings.perNight' | translate }}</div>
              </div>

              <!-- Property Features -->
              <div class="features-grid">
                <div class="feature-item">
                  <i class="bi bi-house-door"></i>
                  <div class="feature-content">
                    <span class="feature-label">{{ 'listings.propertyType' | translate }}</span>
                    <span class="feature-value">{{ listing.type }}</span>
                  </div>
                </div>
                <div class="feature-item">
                  <i class="bi bi-geo-alt"></i>
                  <div class="feature-content">
                    <span class="feature-label">{{ 'listings.destination' | translate }}</span>
                    <span class="feature-value">{{ listing.destination }}</span>
                  </div>
                </div>
                <div class="feature-item">
                  <i class="bi bi-bed"></i>
                  <div class="feature-content">
                    <span class="feature-label">{{ 'listings.bedrooms' | translate }}</span>
                    <span class="feature-value">{{ listing.bedrooms || 'N/A' }}</span>
                  </div>
                </div>
                <div class="feature-item">
                  <i class="bi bi-droplet"></i>
                  <div class="feature-content">
                    <span class="feature-label">{{ 'listings.bathrooms' | translate }}</span>
                    <span class="feature-value">{{ listing.bathrooms || 'N/A' }}</span>
                  </div>
                </div>
                <div class="feature-item">
                  <i class="bi bi-people"></i>
                  <div class="feature-content">
                    <span class="feature-label">{{ 'listings.maxGuests' | translate }}</span>
                    <span class="feature-value">{{ listing.maxGuests }}</span>
                  </div>
                </div>
              </div>

              <!-- Main Action Button -->
              <button class="btn-broker-book" [routerLink]="['/booking/create', listing.id]">
                <i class="bi bi-calendar-check"></i>
                <span>{{ 'listings.bookThisProperty' | translate }}</span>
              </button>

            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Property Description & Amenities -->
    <div class="broker-content-section">
      <div class="container-fluid">
        <div class="row">

          <!-- Description -->
          <div class="col-lg-8">
            <div class="broker-description-card">
              <div class="section-header">
                <h3>{{ 'listings.aboutProperty' | translate }}</h3>
                <i class="bi bi-house-heart"></i>
              </div>
              <div class="description-content">
                <p>{{ listing.description }}</p>
              </div>
            </div>

            <!-- Amenities -->
            <div class="broker-amenities-card" *ngIf="listing.amenities && listing.amenities.length > 0">
              <div class="section-header">
                <h3>{{ 'listings.amenities' | translate }}</h3>
                <i class="bi bi-check2-all"></i>
              </div>
              <div class="amenities-grid">
                <div class="amenity-item" *ngFor="let amenity of listing.amenities">
                  <i class="bi bi-check-circle-fill"></i>
                  <span>{{ amenity }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Additional Info Sidebar -->
          <div class="col-lg-4">
            <div class="broker-info-sidebar">

              <!-- Host Information -->
              <div class="host-section">
                <div class="section-header">
                  <h4>{{ 'listings.hostedBy' | translate }}</h4>
                  <i class="bi bi-person-badge"></i>
                </div>
                <div class="host-info">
                  <div class="host-avatar">
                    <i class="bi bi-person-circle"></i>
                  </div>
                  <div class="host-details">
                    <h5>{{ listing.hostName || 'Property Host' }}</h5>
                    <p>{{ 'listings.verifiedHost' | translate }}</p>
                  </div>
                </div>
              </div>

              <!-- Safety Features -->
              <div class="safety-section">
                <div class="section-header">
                  <h4>{{ 'listings.safetyFeatures' | translate }}</h4>
                  <i class="bi bi-shield-check"></i>
                </div>
                <div class="safety-list">
                  <div class="safety-item">
                    <i class="bi bi-check-circle"></i>
                    <span>{{ 'listings.verifiedProperty' | translate }}</span>
                  </div>
                  <div class="safety-item">
                    <i class="bi bi-check-circle"></i>
                    <span>{{ 'listings.secureBooking' | translate }}</span>
                  </div>
                  <div class="safety-item">
                    <i class="bi bi-check-circle"></i>
                    <span>{{ 'listings.customerSupport' | translate }}</span>
                  </div>
                </div>
              </div>

            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Location Section -->
    <div class="broker-location-section">
      <div class="container-fluid">
        <div class="broker-location-card">
          <div class="section-header">
            <h3>
              <i class="bi bi-geo-alt-fill"></i>
              {{ 'listings.location' | translate }}: {{ listing.location }}
            </h3>
            <div class="location-badge">
              <i class="bi bi-map"></i>
              {{ 'listings.viewOnMap' | translate }}
            </div>
          </div>
          <div class="map-container">
            <div id="detail-map" class="detail-map"></div>
          </div>
          <div class="location-description">
            <p>{{ 'listings.locationDescription' | translate }}</p>
          </div>
        </div>
      </div>
    </div>

<!-- Reviews Section -->
<div class="broker-reviews-section" *ngIf="listing">
  <div class="container-fluid">
    <div class="broker-reviews-card">

      <!-- Review Header -->
      <div class="review-header-main">
        <h2>
          <i class="bi bi-star-fill"></i>
          Guest Reviews
        </h2>
        <div class="review-count">
          {{ totalReviews }} review{{ totalReviews !== 1 ? 's' : '' }}
        </div>
      </div>

      <!-- Overall Rating -->
      <div class="broker-overall-rating" *ngIf="totalReviews > 0">
        <div class="rating-summary">
          <div class="rating-number-main">
            {{ overallRating }}
          </div>
          <div class="star-display-main">
            <ng-container *ngFor="let star of [1,2,3,4,5]">
              <i [class]="star <= overallRating ? 'bi bi-star-fill' : (star - 0.5 <= overallRating ? 'bi bi-star-half' : 'bi bi-star')"></i>
            </ng-container>
          </div>
          <div class="review-count">
            Overall Rating
          </div>
        </div>

        <!-- Rating Breakdown -->
        <div class="rating-breakdown">
          <div class="breakdown-item" *ngFor="let star of [5,4,3,2,1]">
            <span class="rating-label">{{ star }} star{{ star !== 1 ? 's' : '' }}</span>
            <div class="rating-bar">
              <div class="rating-fill"
                   [style.width.%]="totalReviews ? (ratingCounts[star] / totalReviews * 100) : 0"></div>
            </div>
            <span class="rating-count">{{ ratingCounts[star] }}</span>
          </div>
        </div>
      </div>

      <!-- Review Form -->
      <div class="broker-review-form" *ngIf="canWriteReview">
        <h3>
          <i class="bi bi-pencil-square"></i>
          Write a Review
        </h3>

        <form class="review-form" (ngSubmit)="submitReview()">
          <!-- Booking Selection -->
          <div class="broker-form-group">
            <label for="bookingId">Select Your Booking <span class="text-danger">*</span></label>
            <select id="bookingId" name="bookingId" class="broker-input"
                    [(ngModel)]="newReview.bookingId" required>
              <option value="0" disabled>-- Select a completed booking to review --</option>
              <option *ngFor="let booking of userBookingsForThisListing" [value]="booking.id">
                Booking #{{ booking.id }} - {{ booking.checkInDate | date:'shortDate' }} to {{ booking.checkOutDate | date:'shortDate' }}
              </option>
            </select>
            <small class="text-muted">You can only review properties after your stay is completed</small>
          </div>

          <!-- Rating Selection -->
          <div class="broker-rating-selector">
            <label>Your Rating: <span class="text-danger">*</span></label>
            <div class="broker-star-btns">
              <button type="button" class="broker-star-btn"
                      *ngFor="let star of [1,2,3,4,5]"
                      [class.active]="star <= newReview.rating"
                      (click)="newReview.rating = star">
                <i [class]="star <= newReview.rating ? 'bi bi-star-fill' : 'bi bi-star'"></i>
              </button>
            </div>
          </div>

          <!-- Review Comment -->
          <div class="broker-form-group">
            <label for="comment">Your Review <span class="text-danger">*</span></label>
            <textarea id="comment" name="comment" class="broker-textarea"
                      placeholder="Share details of your experience at this property..."
                      [(ngModel)]="newReview.comment" name="comment" rows="4" required></textarea>
          </div>

          <!-- Submit Button -->
          <div class="broker-form-actions">
            <button type="submit" class="btn-broker-primary"
                    [disabled]="newReview.bookingId === 0 || newReview.rating === 0 || !newReview.comment">
              <i class="bi bi-send-fill"></i>
              Submit Review
            </button>
          </div>
        </form>
      </div>

      <!-- No Booking Message -->
      <div class="broker-no-booking-message" *ngIf="!canWriteReview && userBookings.length >= 0">
        <div class="no-booking-content">
          <i class="bi bi-calendar-x"></i>
          <h4>Book this property to leave a review</h4>
          <p>You need to complete a stay at this property before you can write a review.</p>
          <button class="btn-broker-primary" [routerLink]="['/booking/create', listing.id]">
            <i class="bi bi-calendar-check"></i>
            Book Now
          </button>
        </div>
      </div>

      <!-- Reviews List -->
      <div class="broker-reviews-list" *ngIf="totalReviews > 0">

        <!-- Review Cards -->
        <div class="broker-review-cards">
          <div class="broker-review-card" *ngFor="let r of visibleReviews">

            <!-- Review Header -->
            <div class="broker-review-header">
              <div class="broker-reviewer-info">
                <div class="broker-reviewer-avatar" [style.background-image]="r.guestProfileImg ? 'url(' + r.guestProfileImg + ')' : 'none'">
                  <span *ngIf="!r.guestProfileImg">{{ r.guestName | slice:0:1 | uppercase }}</span>
                </div>
                <div class="broker-reviewer-details">
                  <div class="broker-reviewer-name">
                    {{ r.guestName || 'Anonymous Guest' }}
                  </div>
                  <div class="broker-review-date">
                    {{ r.createdAt | date:'mediumDate' }}
                    <span *ngIf="r.updatedAt" class="text-muted small"> (edited)</span>
                  </div>
                </div>
              </div>
              <div class="broker-review-rating">
                <div class="broker-review-stars">
                  <ng-container *ngFor="let star of [1,2,3,4,5]">
                    <i [class]="star <= r.rating ? 'bi bi-star-fill' : 'bi bi-star'"></i>
                  </ng-container>
                </div>
                <div class="broker-review-rating-value">
                  {{ r.rating }}.0
                </div>
              </div>
            </div>

            <!-- Review Content -->
            <div class="broker-review-content">
              <!-- Edit Mode -->
              <div *ngIf="editingReviewId === r.id" class="edit-review-form">
                <div class="broker-rating-selector mb-3">
                  <label>Rating:</label>
                  <div class="broker-star-btns">
                    <button type="button" class="broker-star-btn"
                            *ngFor="let star of [1,2,3,4,5]"
                            [class.active]="star <= editReviewData.rating"
                            (click)="editReviewData.rating = star">
                      <i [class]="star <= editReviewData.rating ? 'bi bi-star-fill' : 'bi bi-star'"></i>
                    </button>
                  </div>
                </div>
                <textarea class="broker-textarea mb-3" [(ngModel)]="editReviewData.comment" rows="4"></textarea>
                <div class="btn-group">
                  <button class="btn-broker-primary btn-sm" (click)="saveEditReview(r.id)">
                    <i class="bi bi-check"></i> Save
                  </button>
                  <button class="btn-broker-outline btn-sm" (click)="cancelEditReview()">
                    <i class="bi bi-x"></i> Cancel
                  </button>
                </div>
              </div>

              <!-- View Mode -->
              <div *ngIf="editingReviewId !== r.id">
                <p class="broker-review-comment">{{ r.comment }}</p>

                <!-- Review Images -->
                <div *ngIf="r.imageUrls && r.imageUrls.length > 0" class="review-images mt-3">
                  <img *ngFor="let img of r.imageUrls" [src]="img" class="review-img" alt="Review image">
                </div>

                <!-- Host Reply -->
                <div *ngIf="r.hostReply" class="host-reply mt-3">
                  <div class="host-reply-header">
                    <i class="bi bi-reply-fill"></i>
                    <strong>Host Response</strong>
                    <span class="text-muted small"> - {{ r.hostReplyDate | date:'mediumDate' }}</span>
                  </div>
                  <p class="host-reply-text">{{ r.hostReply }}</p>
                </div>

                <!-- Reply Form -->
                <div *ngIf="replyingToReviewId === r.id" class="reply-form mt-3">
                  <textarea class="broker-textarea mb-2" [(ngModel)]="hostReplyText" rows="3" placeholder="Write your response..."></textarea>
                  <div class="btn-group">
                    <button class="btn-broker-primary btn-sm" (click)="submitHostReply(r.id)">
                      <i class="bi bi-send"></i> Reply
                    </button>
                    <button class="btn-broker-outline btn-sm" (click)="cancelReply()">
                      <i class="bi bi-x"></i> Cancel
                    </button>
                  </div>
                </div>

                <!-- Flag Form -->
                <div *ngIf="flaggingReviewId === r.id" class="flag-form mt-3">
                  <textarea class="broker-textarea mb-2" [(ngModel)]="flagReason" rows="2" placeholder="Reason for flagging..."></textarea>
                  <div class="btn-group">
                    <button class="btn-broker-warning btn-sm" (click)="submitFlag(r.id)">
                      <i class="bi bi-flag-fill"></i> Submit Flag
                    </button>
                    <button class="btn-broker-outline btn-sm" (click)="cancelFlag()">
                      <i class="bi bi-x"></i> Cancel
                    </button>
                  </div>
                </div>
              </div>
            </div>

            <!-- Review Actions -->
            <div class="broker-review-actions" *ngIf="editingReviewId !== r.id">
              <!-- Helpful Votes -->
              <div class="helpful-votes">
                <button class="vote-btn" (click)="voteHelpful(r.id, true)" title="Helpful">
                  <i class="bi bi-hand-thumbs-up"></i> {{ r.helpfulVotes }}
                </button>
                <button class="vote-btn" (click)="voteHelpful(r.id, false)" title="Not helpful">
                  <i class="bi bi-hand-thumbs-down"></i> {{ r.notHelpfulVotes }}
                </button>
              </div>

              <!-- Action Buttons -->
              <div class="action-buttons">
                <!-- Host Reply Button -->
                <button *ngIf="!r.hostReply && canEdit && replyingToReviewId !== r.id"
                        class="action-btn" (click)="startReply(r.id)">
                  <i class="bi bi-reply"></i> Reply
                </button>

                <!-- Edit Button (for review owner) -->
                <button class="action-btn" (click)="startEditReview(r)">
                  <i class="bi bi-pencil"></i> Edit
                </button>

                <!-- Delete Button (for review owner or admin) -->
                <button class="action-btn text-danger" (click)="deleteReview(r.id)">
                  <i class="bi bi-trash"></i> Delete
                </button>

                <!-- Flag Button -->
                <button *ngIf="flaggingReviewId !== r.id && !r.isFlagged"
                        class="action-btn" (click)="startFlag(r.id)">
                  <i class="bi bi-flag"></i> Flag
                </button>

                <!-- Flagged Indicator -->
                <span *ngIf="r.isFlagged" class="flagged-badge">
                  <i class="bi bi-flag-fill"></i> Flagged
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Load More Button -->
        <div class="broker-load-more" *ngIf="hasMore">
          <button class="btn-broker-outline" (click)="loadMore()">
            <i class="bi bi-arrow-down"></i>
            Load More Reviews
          </button>
        </div>
      </div>

      <!-- No Reviews Section -->
      <div class="no-reviews" *ngIf="totalReviews === 0">
        <div class="text-center py-4">
          <i class="bi bi-chat-square-text display-4 text-muted"></i>
          <h4 class="mt-3 mb-2">No Reviews Yet</h4>
          <p class="text-muted">Be the first to review this property!</p>
        </div>
      </div>

    </div>
  </div>
</div>

    <!-- Bottom Actions -->
    <div class="broker-bottom-actions">
      <div class="container-fluid">
        <div class="actions-row">
          <button class="btn-broker-secondary" (click)="goBack()">
            <i class="bi bi-arrow-left"></i>
            {{ 'listings.backToListings' | translate }}
          </button>
          <div class="primary-actions">
            <button class="btn-broker-outline" *ngIf="canEdit" (click)="editListing()">
              <i class="bi bi-pencil"></i>
              {{ 'listings.editProperty' | translate }}
            </button>
            <button class="btn-broker-primary" [routerLink]="['/booking/create', listing.id]">
              <i class="bi bi-calendar-check"></i>
              {{ 'listings.bookNow' | translate }}
            </button>
          </div>
        </div>
      </div>
    </div>

  </div>
</div>
